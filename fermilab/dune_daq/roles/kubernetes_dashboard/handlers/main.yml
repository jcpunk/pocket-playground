---
- name: "Find information about {{ kubernetes_dashboard_helm_release_name }} via helm"
  kubernetes.core.helm_info:
    release_name: "{{ kubernetes_dashboard_helm_release_name }}"
    release_namespace: "{{ kubernetes_dashboard_namespace }}"
    release_state: deployed
  register: kubernetes_dashboard_helm_info
  changed_when: false
  listen: prometheus installed

- name: "Enable {{ kubernetes_dashboard_helm_release_name }} serviceMonitor via helm"
  ansible.builtin.command:
    argv:
      - "{{ dune_daq_bin_path | expanduser }}/{{ helm_binary_name }}"
      - upgrade
      - "{{ kubernetes_dashboard_helm_release_name }}"
      - "{{ kubernetes_dashboard_helm_repo_name }}/{{ kubernetes_dashboard_helm_chart_name }}"
      - --namespace
      - "{{ kubernetes_dashboard_namespace }}"
      - --reuse-values
      - --version
      - "{{ kubernetes_dashboard_helm_info.status.chart | replace(kubernetes_dashboard_helm_release_name + '-','') }}"
      - --values
      - "{{ dune_daq_conf_path | expanduser }}/kubernetes_dashboard/prometheus_systemmonitor.yml"
  listen: prometheus installed
